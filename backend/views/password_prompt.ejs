<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Protected Link - Enter Password</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        padding: 20px;
        margin: 0;
      }
      
      .container {
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        padding: 40px;
        max-width: 450px;
        width: 100%;
        text-align: center;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      
      h1, p {
        width: 100%;
      }
      
      .lock-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 40px;
        color: white;
        flex-shrink: 0;
      }
      
      h1 {
        font-size: 28px;
        color: #333;
        margin-bottom: 10px;
        font-weight: 600;
      }
      
      p {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
        line-height: 1.5;
      }
      
      .form-group {
        margin-bottom: 25px;
        text-align: left;
      }
      
      label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 500;
        font-size: 14px;
      }
      
      input[type="password"] {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s ease;
        outline: none;
      }
      
      input[type="password"]:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      }
      
      .error-message {
        color: #e74c3c;
        font-size: 14px;
        margin-top: 8px;
        display: none;
      }
      
      .error-message.show {
        display: block;
      }
      
      button {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
        margin-top: 10px;
      }
      
      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
      }
      
      button:active {
        transform: translateY(0);
      }
      
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
        margin-right: 10px;
        vertical-align: middle;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }
      
      .back-link {
        margin-top: 20px;
        color: #667eea;
        text-decoration: none;
        font-size: 14px;
        display: inline-block;
      }
      
      .back-link:hover {
        text-decoration: underline;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="lock-icon">üîí</div>
      <h1>Protected Link</h1>
      <p>This link cannot be accessed without a password. Please enter the password to continue.</p>
      
      <% if (typeof error !== 'undefined' && error) { %>
        <div class="error-message show" id="errorMessage"><%= error %></div>
      <% } else { %>
        <div class="error-message" id="errorMessage"></div>
      <% } %>
      
      <!-- <form id="passwordForm" method="POST" action="/link/verify-password"> -->
        <div>
        <input type="hidden" name="hashedUsername" value="<%= hashedUsername %>" />
        <input type="hidden" name="hashedSource" value="<%= hashedSource %>" />
        <div class="form-group">
          <h1><%= hashedUsername %></h1>
          <h1><%= hashedSource %></h1>
          <label for="password">Password</label>
          <input 
            type="password" 
            id="password" 
            name="password" 
            placeholder="Enter password"
            required
            autocomplete="current-password"
            autofocus
          />
        </div>
        
        <button type="button" id="submitBtn">
          <span id="buttonText">Access Link</span>
        </button>
      <!-- </form> -->
      </div>
      <a href="/" class="back-link">‚Üê Go back to home</a>
    </div>

    <script>
      // const form = document.getElementById('passwordForm');
      const passwordInput = document.getElementById('password');
      const errorMessage = document.getElementById('errorMessage');
      const submitBtn = document.getElementById('submitBtn');
      const buttonText = document.getElementById('buttonText');
      
      submitBtn.addEventListener('click', async(e) => {
        const password = passwordInput.value.trim();
        if (!password) {
          e.preventDefault();
          showError('Please enter a password');
          return;
        }
        
        // Show loading state
        submitBtn.disabled = true;
        buttonText.innerHTML = '<span class="loading"></span>Verifying...';
        errorMessage.classList.remove('show');
        // console.log("password = ",password)
        // console.log("hashedUsername = ",'<%= hashedUsername %>')
        // console.log("hashedSource = ", hashedSource)
        try {
          const response = await fetch('/link/verify-password', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ hashedUsername: '<%= hashedUsername %>', hashedSource: '<%= hashedSource %>', password: password }),
          });
          console.log("response = ",response)
          if(response.ok){
            // window.location.href = response.url;
            console.log("response.url = ",response.url)
          } else {
            showError('Failed to verify password. Please try again.');
          }x
        } catch (error) {
          console.error('Error verifying password:', error);
          showError('Failed to verify password. Please try again.');
        }
      });
      
      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.add('show');
      }
      
      // Clear error on input
      passwordInput.addEventListener('input', () => {
        errorMessage.classList.remove('show');
      });
    </script>
  </body>
</html>
